---
title: "Some epidemiological effects of malarone"
number-sections: true
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

In this analysis we use the formalism of [Smith & McKenzie (2004)](https://malariajournal.biomedcentral.com/articles/10.1186/1475-2875-3-13).

## Parameters

The path to the data:

```{r}
path2data <- paste0(Sys.getenv("HOME"), "/Library/CloudStorage/",
                    "OneDrive-OxfordUniversityClinicalResearchUnit/",
                    "GitHub/choisy/malarone/")
```





## Packages

```{r}
required_packages <- c("readr", "readxl", "dplyr", "purrr", "stringr")
```

```{r}
to_inst <- required_packages[! required_packages %in% installed.packages()[,"Package"]]
if (length(to_inst)) install.packages(to_inst)
```

```{r message = FALSE}
library(dplyr)
```


## Functions

```{r}
readRDS2 <- function(f, ...) tibble::as_tibble(readRDS(paste0(path2data, f), ...))
```

```{r}
plot2 <- function(...) plot(..., col = 4, lwd = 2, pch = 3)
```

```{r}
lines2 <- function(...) lines(..., col = 2, lwd = 2)
```

```{r}
seq2 <- function(...) seq(..., le = 512)
```

```{r}
plotl <- function(...) plot(..., type = "l", lwd = 2, col = 2)
```


## Individual vectorial capacity

From [Smith & McKenzie (2004)](https://malariajournal.biomedcentral.com/articles/10.1186/1475-2875-3-13),
the **individual vectorial capacity** (*i.e.* the expected number of infectious bites
from a single vector after feeding on an infectious host):

$$
C = c \cdot P_e \cdot S
$$

where $c$ is the **transmission efficiency from human to mosquito** (*i.e.* probability
of becoming infected after feeding on an infectious human), $P_e$ is the
**probability of becoming infectious for an infected mosquito**:

$$
P_e = e^{-gn}
$$
(with $g$ the **mosquito death rate** and $n$ the **EIP**), and $S$ is the
**stability index**, *i.e.* the total number of bites per mosquito during its lifetime:

$$
S = \frac{a}{g}
$$
with $a$ the **mosquito biting rate**, *i.e.* the number of bites per mosquito.
Gathering everything gives:

$$
C = c \cdot e^{-gn}\frac{a}{g}
$$ {#eq-ind_vec_cap}

## Experimental results on the effects of malarone

The experimental results suggest that malarone

1. decreases by a multiplicative factor $(1 - \alpha)$ ($0 \leq \alpha \leq 1$) the
number of mosquitoes with *Plasmodium* (Figure 3);
2. decreases by the multiplicative factor $\beta$ ($0 \leq \beta \leq 1$) the number of
*Plasmodium* in mosquitoes still harboring *Plasmodium* (Figure 4);
3. increases the EIP $n$ by a factor $\gamma$ (Figure 5);
4. has no effect on the mosquito biting rate $a$ (Figure 7);
5. has no effect on the mosquito death rate $g$ (Figure 7).

Let's see how we can integrate effects 1-3 into @eq-ind_vec_cap.

### Transmission-blocking activity on sporozoites

A function that reads the sporozoites data for the treatment group:

```{r}
make_reading_exp_data <- function() {
  hours <- c(0, 5, 48, 72)
  days <- c(5, 7, 14, 28)
  hash <- c(setNames(hours, paste0("H", hours)),
            setNames(24 * days, paste0("D", days)))
  function(file) {
    file |>
      readRDS2() |> 
      filter(treatment == "AL+AP") |> 
      mutate(time_hours = hash[stringr::str_remove(time_points, "0")],
             across(Inhibition, ~ .x / 100))
  }
}

reading_exp_data <- make_reading_exp_data()
```

Let's pull out the data from Figure 3B:

```{r}
sporozoitsTBA <- reading_exp_data("percentage_inhibition9.rds")
```

A function that converts a data frame on the effet of malarone on sporozoites into a
function:

```{r}
data2function <- function(data) {
  data |> 
    group_by(time_hours) |> 
    summarise(median_val = max(0, median(Inhibition))) |> 
    bind_rows(tibble(time_hours = 0, median_val = 0)) |> 
    arrange(time_hours) |> 
    with(function(x, ...) approx(time_hours, median_val, x, ...)$y)
}
```

Let's now create a function `alpha()` on percentage $\alpha(t)$ inhibition on
sporozoite infection rate as a function of time $t$ post drug administration:

```{r}
alpha <- data2function(sporozoitsTBA)
```

A function that plots the experimental data on the effect of malarone on sporozoites:

```{r}
plot_effect_sporozoites <- function(data, ...) {
  with(data, plot2(jitter(time_hours), Inhibition,
                   xlab = "time post drug administration (hours)", ...))
  abline(h = 0)
}
```

This is what this function looks like:

```{r}
plot_effect_sporozoites(sporozoitsTBA, ylim = c(-1, 1),
                        ylab = expression(paste("sporozoite TBA ", alpha)))
xs <- seq2(0, 700)
lines2(xs, alpha(xs))
```


The effect on $C$ of the first phenomenon can simply be modelled as a multiplicative
factor $\alpha$:
$$
C' = (1 - \alpha) C
$$

### Transmission-reducing activity on sporozoites

Let’s pull out the data from Figure 4B:

```{r}
sporozoitsTRA <- reading_exp_data("percentage_inhibition13.rds")
```

Let's now create a function `beta()` on percentage $\beta(t)$ inhibition on
sporozoite intensity as a function of time $t$ post drug administration:

```{r}
beta <- data2function(sporozoitsTRA)
```

This is what this function looks like:

```{r}
plot_effect_sporozoites(sporozoitsTRA, ylim = c(-.15, .15),
                        ylab = expression(paste("sporozoite TRA ", beta)))
lines2(xs, beta(xs))
```

In order to convert this sporozoite TRA into a vectorial capacity reduction, we need a
function $f$ that converts a sporozoite load into an infection probability. Figure 2B
from [Aleshnick *et al.* (2020)](https://journals.plos.org/plospathogens/article?id=10.1371/journal.ppat.1008181)
provides such a function that we transpose in the `f()` function below:

```{r}
make_f <- function(x1, x2, y1, y2) {
  function(x) {
    purrr::map_dbl(x, function(x) {
                        if (x < x1) return(x * y1 / x1)
                        y1 + (x - x1) * (y2 - y1) / (x2 - x1)
                      })
  }
}

f <- make_f(x1 = 21111, x2 = 1e5, y1 = .285, y2 = .344)
```

And this is what it looks like:

```{r}
xs2 <- seq2(0, 1e5)
plotl(xs2, f(xs2),
      xlab = "salivary gland sporozoite load", ylab = "infection probability")
```

In order to model the effect on $C$ of the second phenomenon we need a function $f$
that relates the *Plasmodium* load to mosquito-to-human infectiousness:

$$
C' = \frac{f((1 - \beta) S)}{f(S)}C
$$

### Increase of the EIP

Let’s pull out the data from Figure 5A:

```{r}
oocysts_size <- reading_exp_data("percentage_inhibition_size2.rds")
```

Let's now create a function `gamma()` on percentage $\gamma(t)$ decrease
sporozoite intensity as a function of time $t$ post drug administration:

```{r}
gamma <- data2function(oocysts_size)
```

This is what this function looks like:

```{r}
plot_effect_sporozoites(oocysts_size, ylim = c(-.65, .65),
                        ylab = expression(
                          paste("sporozoite size reduction factor ", gamma)))
lines2(xs, gamma(xs))
```

Next, we need to convert a reduction in oocysts size at 7 dpi into an extension of the
EIP. Figure 5B from [Werling *et al.* (2019)](https://www.cell.com/cell/fulltext/S0092-8674(19)30219-3?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS0092867419302193%3Fshowall%3Dtrue)
suggests a linear relationship between the development time and oocysts size, which
means that the effect on $C$ of the third phenomenon can simply be modelled as

$$
C' = e^{(1 - 1/\gamma)gn} C
$$

### Combining the 3 effects

Combining the 3 above effects for a mosquito that feeds on a human host that started
malarone $t$ units earlier, we have:

$$
C' = (1 - \alpha(t)) \frac{f((1 - \beta(t)) S)}{f(S)} e^{(1 - 1/\gamma(t))gn} C
$$

The corresponding R code is:

```{r}
C_effect_at_t <- function(t, S, g, n) {
  (1 - alpha(t)) * f((1 - beta(t)) * S) * exp((1 - 1 / gamma(t)) * g * n) / f(S)
}
```

The expected effect of malarone on a mosquito that feeds on a human who is infected and
has taken a treatment, not knowing when, would read:

$$
C' = \frac{C}{D}\int_0^D(1 - \alpha(t)) \frac{f((1 - \beta(t)) S)}{f(S)} e^{(1 - 1/\gamma(t))gn}dt
$$

where $D$ if the duration of infection in the human host. The corresponding R code is:

```{r}
C_effect_on_treated <- function(D, S, g, n) {
  integrate(C_effect_at_t, 0, D, S, g, n) / D
}
```

Finally, if $P$ is the prevalence in the human population and $\tau$ is the proportion
of infected people that are treated, the mean effect of malarone on the individual
vectorial capacity is:

$$
C' = \left(\frac{\tau P}{D}\int_0^D(1 - \alpha(t)) \frac{f((1 - \beta(t)) S)}{f(S)} e^{(1 - 1/\gamma(t))gn}dt + 1 - \tau P\right)C
$$

and the corresponding R code is:

```{r}
mean_C_effect <- function(D, S, g, n, P, tau) {
  1 + tau * P * (C_effect_on_treated(D, S, g, n) - 1)
}
```

```{r}
mean_C_effect <- function(D, S, g, n, P, tau) {
  1 - tau * P * (1 - C_effect_on_treated(D, S, g, n))
}
```


## Numerical analysis

```{r}
C_effect_at_t(t = 100, S = 6e4, g = 1 / (14 * 24), n = 7 * 24)
```

```{r}
xs3 <- seq(0, 24 * 28, le = 2^10)
plotl(xs3, C_effect_at_t(t = xs3, S = 6e4, g = 1 / (14 * 24), n = 7 * 24))
```

```{r}
C_effect_on_treated(D = 14 * 24, S = 6e4, g = 1 / (14 * 24), n = 7 * 24)
```







## Basic reproduction ratio

The **basic reproduction ratio** is the expected number of infected humans per infected
human or, equivalently, the expected number of infected mosquitoes per infected
mosquito:

$$
R_0 = C \cdot b \cdot  \frac{a}{r} \cdot m
$$

where $C$ is the above defined **individual vectorial capacity**, $b$ is the
**transmission efficiency from mosquito to human**, $r$ is the **human recovery rate**,
and $m$ is the **ratio of mosquitoes to humans**. Gathering everything gives:

$$
R_0 = \frac{ma^2 bc e^{-gn}}{rg}
$$

## Proportion of infected humans

The proportion of infected humans at equilibrium can be expressed as a function of
$R_0$:

$$
\bar{X} = \frac{R_0 - 1}{R_0 + c S}
$$

Gathering everything gives:

$$
\bar{X} = \frac{ma^2bce^{-gn} - rg}{ma^2bce^{-gn} + rac}
$$

## Adding the effects of malarone

Effects of **transmission blocking activity** (TBA, **Figure 3**) and the extension of
the **Extrinsic Incubation Period** (EIP, **Figure 5**) on the individual vectorial
capacity:

$$
C = (\mbox{TBA}\cdot c) \cdot e^{-\left(\mbox{EIP}\cdot n\right)g}\frac{a}{g}
$$
Note that malarone has no effect on $a$ and $g$ (**Figure 7**). Effect of TBA, EIP and
**transmission reducing activity** (TRA, **Figure 4**) on the basic reproduction ratio:

$$
R_0 = \frac{ma^2 (\mbox{TRA}\cdot b)(\mbox{TBA}\cdot c) e^{-\left(\mbox{EIP}\cdot n\right)g}}{rg}
$$

Note that here we don't consider the potential effects of malarone on the recovery rate
$r$ in humans and that we assume that malarone has no effect on the density $m$ of
mosquitoes.

Effects of TBA, TRA and EIP on the proportion of infected humans:

$$
\bar{X} = \frac{ma^2(\mbox{TRA}\cdot b)(\mbox{TBA}\cdot c)e^{-\left(\mbox{EIP}\cdot n\right)g} - rg}{ma^2(\mbox{TRA}\cdot b)(\mbox{TBA}\cdot c)e^{-\left(\mbox{EIP}\cdot n\right)g} + ra(\mbox{TBA}\cdot c)}
$$


